
var prv = [];

prv['нг']=1e12;
prv['мг']=1e6;
prv['г']=1000;
prv['кг']=1;
prv['ц']=0.01;
prv['т']=0.001;
prv['кт']=1e-6;
prv['Н']=9.806652;
prv['кН']=9.806652e-3;
prv['emu']=6.0225e26;
prv['кар.']=5000;
prv['унц.']=35.273;
prv['lb']=2.20462262185;
prv['р.ф.']=2.442;
prv['п.']=0.0610500610501;

prv['с']=7*24*60*60;
prv['мин']=7*24*60;
prv['ч']=7*24;
prv['сут.']=7;
prv['нед.']=1;
prv['в.']=1.916536e-4;
prv['г.']=1.916536e-2;

prv['км/с']=0.001;
prv['м/с']=1;
prv['км/ч']=3.6;
prv['м/мин']=60;
prv['mps']=6.213712e-4;
prv['mph']=2.236936;
prv['fps']=3.28084;
prv['fpm']=196.8504;
prv['узл.']=1.943844;

prv['Па']=1;
prv['кПа']=1e-3;
prv['гПа']=1e-2;
prv['МПа']=1e-6;
prv['Н/м<sup>2</sup>']=1;
prv['торр']=0.007500616;
prv['атм']=9.869233e-06;
prv['ат']=1.019716e-05;
prv['бар']=1e-05;

prv['ед.']=1;
prv['%']=1e2;
prv['‰']=1e3;
prv['моль']=1.660531e-24;
prv['ppm']=1e6;
prv['ppb']=1e9;

prv['м<sup>3</sup>/с']=0.001;
prv['м<sup>3</sup>/мин']=0.06;
prv['м<sup>3</sup>/ч']=3.6;
prv['м<sup>3</sup>/сут']=86.4;
prv['м<sup>3</sup>/год']=31556.93;
prv['л/с']=1;
prv['л/мин']=60;
prv['л/ч']=3600;
prv['л/сут']=86400;
prv['л/год']=3.155693e7;

prv['т/с']=0.001;
prv['т/мин']=0.06;
prv['т/ч']=3.6;
prv['т/сут.']=86.4;
prv['кг/с']=1;
prv['кг/мин']=60;
prv['кг/ч']=3600;
prv['кг/сут.']=86400;
prv['г/с']=1e3;
prv['г/мин']=6e4;
prv['г/ч']=3.6e6;
prv['г/сут.']=8.64e7;

prv['А']=1e10;
prv['нм']=1e9;
prv['мкм']=1e6;
prv['мм']=1e3;
prv['см']=100;
prv['дм']=10;
prv['м']=1;
prv['км']=0.001;
prv['пк']=3.240779e-17;
prv['ly']=1.057023e-16;
prv['au']=6.684587e-12;
prv['лье']=2.071237e-4;
prv['mi']=6.213712e-4;
prv['yd']=1.093613;
prv['ft']=3.28084;
prv['in']=39.37008;
prv['лин.']=472.4409;
prv['pt']=2659.575;

prv['н•м']=1;
prv['н•см']=100;
prv['дин•м']=1e5;
prv['дин•см']=1e7;
prv['кгс•м']=0.1019716;
prv['кгс•см']=10.19716;
prv['гс•м']=101.9716;
prv['гс•см']=10197.16;

prv['окр.']=1;
prv['пи']=2;
prv['rad']=2*Math.PI;
prv['°']=360;
prv['grad']=400;
prv["'"]=21600;
prv["''"]=1.296e6;
prv['р.']=32;

prv['МВт']=1e-06;
prv['кВт']=1e-3;
prv['Вт']=1;
prv['кал/с']=0.2388459;
prv['bhp']=1.019589e-4;
prv['ehp']=1.34048e-3;
prv['л.с.']=1.341022e-3;
prv['mhp']=1.35962e-3;
prv['кгс•м/с']=0.1019716;
prv['Дж/с']=1;
prv['Дж/ч']=3600;
prv['эрг/с']=1e7;

prv['мм/с<sup>2</sup>']=1e3;
prv['м/с<sup>2</sup>']=1;
prv['км/с<sup>2</sup>']=1e-3;
prv['m/s<sup>2</sup>']=6.213712e-4;
prv['ft/s<sup>2</sup>']=3.28084;
prv['in/s<sup>2</sup>']=39.37008;
prv['g']=0.1019716;


prv['баррель(UK)']=6.1106018;
prv['баррель неф']=6.289782;
prv['bbl(US)']=8.62069;
prv['bu(UK)']=27.4961;
prv['bu(US)']=28.3774;
prv['gal(UK)']=219.9736;
prv['gal(US)']=264.2007;
prv['галлон(US)']=227.0148;
prv['pt(UK)']=1759.9437;
prv['lig pt(US)']=2113.71803;
prv['gry pt(US)']=1816.20051;
prv['fl*oz (UK)']=35198.8736;
prv['fl*oz (US)']=33829.4993;
prv['in3']=61023.61;
prv['ft3']=35.3232;
prv['yd3']=1.30796;


prv['м3']=1;
prv['дм3']=1e3;
prv['см3']=1e6;
prv['мм3']=1e9;
prv['hl']=10;
prv['dl']=100;
prv['л']=1e3;
prv['мл']=1e6;
prv['gal']=264.1721;
prv['qt']=1056.688;
prv['pt']=2113.376;
prv[':-)']=16260.16;

prv['ГДж']=1e-09;
prv['МДж']=1e-06;
prv['кДж']=1e-03;
prv['Дж']=1;

prv['Гкал']=2.388459e-10;
prv['Мкал']=2.388459e-7;
prv['ккал']=2.388459e-4;
prv['кал']=0.2388459;
prv['кВт•ч']=1/3.6e6;
prv['эрг']=1e7;
prv['эВ']=6.24145e18;
prv['м•кг']=0.1026082;
prv['квад']=9.478134e-19;
prv['BTU']=9.478134e-4;
prv['т ТНТ']=2.168224e-10;
prv['кг ТНТ']=2.168224e-07;
prv['тут']=3.4129692e-11;

prv['МВт•ч']=0.278e-09;
prv['1000 м3 п. газа']=0.025e-09;
prv['т мазута']=0.028e-09;

prv['км<sup>2</sup>']=1e-6;
prv['м<sup>2</sup>']=1;
prv['см<sup>2</sup>']=1e4;
prv['мм<sup>2</sup>']=1e6;
prv['га']=1e-4;
prv['д.']=1e-3;
prv['ар']=1e-2;
prv['б']=1e28;
prv['акр']=2.471054e-4;
prv['кв.']=0.1076391;
prv['yd<sup>2</sup>']=1.19599;
prv['ft<sup>2</sup>']=10.76391;
prv['in<sup>2</sup>']=1550.003;
prv['дес.']=9.152985e-05;

prv['l/100km']=-1;
prv['км/л']=1;
prv['g/100m']=-1;
prv['mpg']=1;


prv['Вт/(м•К)']=1;
prv['Btu/(s•ft•degF)']=1.612e-4;
prv['кал/(с•см•0С)']=0.0023883;
prv['ккал/(час•м•0С)']=0.8598;
prv['эрг/(с•см•К)']=1e5;


prv['Дж/(кг•К)']=1;
prv['кал./(г•0С)']=2.3885e-4;
prv['ккал./(кг•0С)']=2.3885e-4;

prv['°C']=1;
prv['°F']=1.8;
prv['K']=1;
prv['°R']=0.8;
prv['°Ra']=1.8;

$(function(){

    var calculator = {
        // Constants. Default per unit prices
        consolidationUnitPrice: 8,
        orderUnitPrice: 6,

        // Процент
        rateIncrease: 6,

        /**
         * Calculates order
         * 
         * @param int price
         * @param int weight
         * @return float|int
         */
        calculateOrder: function(price, weight){
            var x = parseFloat(price) + (weight * this.orderUnitPrice);
            var y = this.rateIncrease * price / 100;
            var result = +(x +y).toFixed(2);

            return result;
        },

        /**
         * Calculate consolidation price
         * 
         * @param int value
         * @return float|int
         */
        calculateConsolidation: function(value){
            return +(value * this.consolidationUnitPrice).toFixed(3);
        },

        /**
         * Returns selecteed type
         * 
         * @return string
         */
        getSelectedType: function(){
            return $("[data-calculator-method]:checked").attr('data-calculator-method');
        },

        /**
         * Returns currently selected unit price
         * 
         * @return int|float
         */
        getSelectedUnitPrice: function(){
            // Only two options are possibled
            if (this.getSelectedType() == 'order'){
                return this.orderUnitPrice;
            } else {
                return this.consolidationUnitPrice;
            }
        },

        /**
         * Update unit price view
         */
        updatePrice: function(){
            var price = this.getSelectedUnitPrice();
            // Render active unit price
            $("[data-calculator-price]").text(price);
        },

        /**
         * Show/Hide description label
         */
        updatePercentageDescription: function(){
            if (this.getSelectedType() == 'order'){
                $(".order-description-percentage").show();
            } else {
                $(".order-description-percentage").hide();
            }
        },
        
        /**
         * Start watching changes in calculator
         */
        watch: function(){
            var self = this;
            self.updatePercentageDescription();

            $("[data-calculator-method]").change(function(){
                var type = $(this).attr('data-calculator-method');
                var $label = $("#sum").parent().find('label');
                // Whether should be disabled or not
                var disabled = type !== 'order';
                
                $("#sum").prop('disabled', disabled);

                if (disabled){
                    $label.addClass('label-gray');
                } else {
                    $label.removeClass('label-gray');
                }

                self.updatePercentageDescription();
                self.updatePrice();
            });

            $(".btn-order").click(function(){
                var url = $("[data-calculator-method]:checked").attr('data-url');
                window.location = url;
            });

            $('[data-calculator-input]').keyup(function(){
                var weight = $('[data-calculator-input]').filter('[data-calculator-input="weight"]').val();

                if (self.getSelectedType() == 'order'){
                    var price = $('[data-calculator-input="price"]').val();
                    var total = self.calculateOrder(price, weight);
                } else {
                    var total = self.calculateConsolidation(weight);
                }

                // if empty or null
                if (!weight){
                    total = 0;
                }

                $(".total-price").text(total);
            });

            // Render active unit price
            self.updatePrice();
        }
    };

    // Converter class
    var converter = {
        // Input selectors
        fromSelector: '#fromInput',
        toSelector: '#toInput',
        
        /**
         * Returns selected converstation value
         * 
         * @param string type Either from or to
         * @return string
         */
        getSelectedConvertationValue: function(type){
            var selector = "[data-converter-type='" + type + "']";
            return $(selector).attr('data-converter-selected-value');
        },

        /**
         * Converts one value to another
         * 
         * @param string value Target value
         * @param string fromRate From rate value
         * @param string toRate To rate value
         * @return float|integer
         */
        convertInternal: function(value, fromRate, toRate){
            var diff = value * prv[fromRate] / prv[toRate];
            var e = 0; // Exponent

            if (diff == 0) {
                return 0;
            } else if (Math.abs(diff) < 1e-1) {
                while (Math.abs(diff) < 1) {
                    diff = diff * 10;
                    e++;
                }

                diff = Math.round(1000 * diff) / 1000;

                if (diff == 10) {
                    diff = 1;
                    e--;
                }

                return +(diff + "e-" + e);
            } else if (Math.abs(diff) > 1e3) {
                while (Math.abs(diff) >= 10) {
                    diff = diff / 10;
                    e++;
                }

                diff = Math.round(1000 * diff) / 1000;
                diff = diff.toFixed(3);

                return +(diff + "e" + e);
            } else {

                var value = (Math.round(1000 * diff) / 1000);
                diff = diff.toFixed(3);
                return value;
            }
        },

        /**
         * Converts one value to another
         * 
         * @param string to To input selector
         * @param string from From input selector
         * @param string fromRate From rate value
         * @param string toRate To rate value
         * @return void
         */
        convert: function(to, from, fromRate, toRate){
            var input = $(from).val();
            var value = this.convertInternal(input, fromRate, toRate);

            $(to).val(value);
        },

        /**
         * Validate inputs
         * 
         * @return boolean
         */
        validate: function(){
            var fail = false;
            var errorClass = 'error';

            $("[data-converter-selected-value]").each(function(){
                var $self = $(this);
                var $button = $self.parent().children('button');
                var value = $self.attr('data-converter-selected-value');

                if (value == ''){
                    $button.addClass(errorClass);
                    fail = true;
                }

                if (value != '' && $button.hasClass(errorClass)) {
                    $button.removeClass(errorClass);
                }
            });

            return !fail;
        },
        
        /**
         * Load dropdown params
         */
        loadParams: function(){
            // Selected category
            var category = $(this).find(':selected').data('converter-category');
            // Create new selector to display associated
            var selector = "[data-converter-item='" + category + "']";

            // Hide all if any
            $("[data-converter-item]").hide();
            $(selector).show();
        },

        /**
         * Convert from left input
         */
        convertFromLeft: function(){
            if (this.validate()){
                this.convert(this.toSelector, this.fromSelector, this.getSelectedConvertationValue('to'), this.getSelectedConvertationValue('from'));
            }
        },

        /**
         * Convert from right input
         */
        convertFromRight: function(){
            if (this.validate()){
                this.convert(this.fromSelector, this.toSelector, this.getSelectedConvertationValue('from'), this.getSelectedConvertationValue('to'));
            }
        },

        /**
         * Bootstraps the converter
         */
        watch: function(){
            $(".first-converter-control").keyup(function(){
                converter.convertFromLeft();
            });

            $(".second-converter-control").keyup(function(){
                converter.convertFromRight();
            });

            $("#converter-category-dropdown").ready(converter.loadParams)
                                             .change(converter.loadParams);

            // Store selected values
            $("[data-converter-item]").click(function(){
                var value = $(this).data('converter-item-value');
                var $output = $(this).parent().parent().children('button').find("[data-converter-value]");

                $output.text(value);
                $(this).parent().attr('data-converter-selected-value', value);

                var $ul = $(this).parent();
                var type = $ul.attr('data-converter-type');

                if (type == 'from'){
                    converter.convertFromRight();
                } else {
                    // Here type is 'to' obviously
                    converter.convertFromLeft();
                }
            });
        }
    };

    // Start watching
    converter.watch();
    calculator.watch();

});
